---
title: "Teoria Macroeconômica II - Artigo parte I"
author: "Aishameriane Schmidt"
date: "31 de janeiro de 2018"
header-includes:
   - \usepackage{bigints}
   - \usepackage[brazil]{babel}
   - \usepackage{graphicx}
   - \usepackage{amsmath}
output: html_document
bibliography: references.bib
---

Este documento é só exploratório e fiz ele para consumo próprio.

# Dúvidas

1. **Tem como fazer alguma conversão dos valores pré-plano real para tributo do trabalho e capital para não perder as 30 primeiras observações?**

<span style="color:purple">Aisha:</span> _Não tem o que fazer._

2. **Tem que fazer alguma coisa com a sazonalidade e tendência?**

<span style="color:purple">Aisha:</span> _É para usar o filtro automático mas explicar bem o que ele faz._ <span style="color:blue">Update:</span> Precisei quebrar algumas séries para tirar a sazonalidade dos pedaços antes de juntar de volta.

3. **No artigo de bayesiana eu havia utilizado a SELIC overnight. Aí fui ver no site do Bacen e só tem a série `4390`- Taxa de juros (Selic acumulada no mês). Qual a diferença entre essas duas?**

<span style="color:purple">Aisha:</span> _Usar a SELIC do Bacen é melhor (<span style="color:red">depois tem que voltar aqui e escrever quais as diferenças entre essas séries e porque a do Bacen é melhor</span>), porém tem que lembrar de passar para valores anuais (por enquanto estava mensal)._ <span style="color:blue">Update:</span> _Fui procurar e entendi o que é a Selic Overnight (que tem no IPEA), mas ainda não entendi o que é a Selic acumulada no mês do Banco Central._ <span style="color:blue">Update:</span> _A Selic Acumulada no site do Bacen e a Selic Overnight do site do IPEA tem os mesmos valores. E a Selic Acumulada é feita usando a Selic diária (série `11`) com a fórmula de juros compostos._   <span style="color:red"> **Agora resta saber por que a série `11` tem formato tão de escadinha.**</span>

4. **Quais outras variáveis adicionar no modelo?**

<span style="color:purple">Aisha:</span> _Olhar o que o Mumtaz usou no VAR dele. Basicamente procurar por produto, inflação, câmbio (talvez)..._
<span style="color:blue">Update:</span> O Mumtaz usou, além de uma variável para desigualdade (na verdade ele montou 4 índices de Gini usando microdados), a taxa de juros (títulos de 3 meses), inflação, taxa de câmbio e produto per capita.

5. **Qual a temporalidade dos dados?**

<span style="color:purple">Aisha:</span> _De acordo com o Guilherme, se usar câmbio o melhor é fazer a partir do fim da âncora cambial_. Fui olhar e isso implica começar a série em Janeiro/99, quando foi adotado o regime de metas de inflação (http://www.rep.org.br/pdf/87-1.pdf). ~~Por enquanto eu vou rodar desde 94 e depois eu adapto, se for o caso.~~ Fui ver e a série do IBC-Br começa em 2003, daí fode tudo. <span style="color:blue">Update:</span> Fiquei com o PIB mensal mesmo, usei 48 meses como priori. Para o Swap DI eu completei a série de jan/96 a ago/99 usando os dados da Selic.

6. **O que é o equivalente tupiniquim de _three month treasury bill rate_?**

<span style="color:purple">Aisha:</span>  Dá para usar isso? https://cran.r-project.org/web/packages/GetTDData/vignettes/gtdd-vignette_GetTDData.html . <span style="color:blue">Update:</span> O Portela disse o seguinte <span style="color:grey"> " _Oi Aisha, Você poderia usar a taxa do swap DI-Pré de 3 meses. Dá pra baixar do banco central ou então pelo BETS. Um abraço_".</span> No banco central, a série é `7818`- _Taxa referencial de swaps DI pré-fixada (BM&F) - Prazo de 90 dias (fim de período)_. **Mas eu não entendi que trem é esse... como que isso se relaciona com política monetária? E qual seria a justificativa para usar isso e não a taxa de juros da economia para colocar no VAR do Mumtaz?** <span style="color:blue">Update:</span>

7. **Log differences é a diferença dos logs ou o log da diferença?**

<span style="color:purple">Aisha:</span> Dar uma olhada no material de macro, uma delas era taxa de crescimento (diferença dos logs).

8. **Como calcular a taxa de crescimento da taxa de câmbio efetiva nominal?**

<span style="color:purple">Aisha:</span> Sei lá. O Mumtaz usa _growth of the nominal effective exchange rate_, mas aí não sei se ele faz a diferença dos logs e por isso chama assim ou se ele calcula a taxa de crescimento e depois faz a diferença dos logs. <span style="color:red">**Eu posso dar uma olhada no código deles depois**.</span>

9. **Como o Diogo calculou a distribuição da renda e o coeficiente de Gini?**

10. **Qual a diferença na interpretação da FIR quando eu divido o IPCA e o Swap por 100 de quando eu multiplico as outras três variáveis por 100?**

11. **Pq a variância diminui quando acrescento a segunda defasagem? Pq o valor do coeficiente da primeira defasagem variamais quando acrescento mais uma defasagem?**

12. **O que pode ter ocorrido em 2006 para ter a quebra estrutural da selic?**

13. **O que pode ter ocorrido em janeiro de 2004 para ter a quebra estrutural da razão capital trabalho?**

14. **Quando aplico o ajuste sazonal na razão capital trabalho aparecem valores negativos. Tem problema?**

# Baixando os dados

## Dependências dos pacotes

```{r, warning = FALSE, message = FALSE}
chooseCRANmirror(graphics = FALSE, ind = 10)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(ggplot2, forecast, BETS, seasonal, seasonalview, lubridate, zoo, stargazer, gridExtra, reshape2, ggfortify, RColorBrewer, scales, quantmod, PerformanceAnalytics, strucchange, latex2exp, dplyr,knitr, grid, ggpubr, gdata)
```

# Download dos dados

Os dados podem ser pegos de https://www3.bcb.gov.br/sgspub/localizarseries/localizarSeries.do?method=prepararTelaLocalizarSeries:

**Renda do trabalho**: Receitas tributárias - Regime de competência - Imposto de renda - Retido na fonte - Rendimento do trabalho (7620)

**Renda do capital**: Receitas tributárias - Regime de competência - Imposto de renda - Retido na fonte - Rendimento do capital (7621)

Ambas séries são mensais e começam em 31/01/1992. O último dado disponível em 05/01/2018 era de novembro de 2017, totalizando 311 meses. O pacote BETS consegue fazer download das séries apenas usando o código delas. Cortando em 1994 (por causa do plano real) ficam 281 observações (vou deixar para ver o trem da âncora cambial depois).

<span style="color:blue">**Update:**</span> Por enquanto estou incluindo IBC-Br o que me deixa com 177 observações apenas...

```{r}
trabalho <- BETS.get("7620")
capital <- BETS.get("7621")

autoplot(trabalho, main = "Renda do trabalho")
autoplot(capital, main = "Renda do capital")

trabalho <- BETS.get("7620", from = "1994-07-01", to = "1998-11-01")
autoplot(trabalho, main = "Renda do trabalho - Jul/94 a Nov/17")

capital <- BETS.get("7621", from = "1994-07-01", to = "1998-11-01")
autoplot(capital, main = "Renda do Capital - Jul/94 a Nov/17")

capital_trabalho <- capital/trabalho
autoplot(capital/trabalho, main = "Razão capital/trabalho - Jul/94 a Nov/17")

length(capital_trabalho)
```

Inicialmente eu fiz um primeiro VAR apenas com Selic e razão capital/trabalho. Havia a dúvida se era melhor usar a Selic do site do BACEN ou a Selic Overnight do site do IPEA. De acordo com o Guilherme, o melhor é o do Bacen pois é a efetiva (não entendi bem essa história...), mas lá em Bayesiana ele não me disse isso "_porque estava ocupado me ensinando o que era Selic_".

## Uma digressão sobre as taxas de juros SELIC

Do site do Banco Central, tem essa definição:
* "_Define-se Taxa Selic como a taxa média ajustada dos financiamentos diários apurados no Sistema Especial de Liquidação e de Custódia (Selic) para títulos federais. Para fins de cálculo da taxa, são considerados os financiamentos diários relativos às operações registradas e liquidadas no próprio Selic e em sistemas operados por câmaras ou prestadores de serviços de compensação e de liquidação_" ([Link](http://www.bcb.gov.br/htms/selic/conceito_taxaselic.asp?idpai=SELICTAXA)).

[Aqui tem uma explicação do que é a Selic Overnight](http://www.infomoney.com.br/noticias/noticia/2001536/entenda-relacao-entre-selic-fixada-pelo-copom-taxa-over-dos):

* "_(...) A Selic Over é obtida a partir do financiamento no mercado interbancário lastreado em títulos públicos, sendo calculada diariamente. (...) Essa taxa surge da necessidade de financiamento de quem está comprando títulos públicos._" No site ainda tem um exemplo que ajuda a entender melhor.

Mas isso ainda não explica o que é a série `4390 - Taxa de juros - Selic acumulada no mês` que tem no sistema do Banco Central. Olhando na caixinha de explicações metodológicas, diz que ela é derivada da série `11 - Taxa de Juros - Selic`. Essa taxa `11` está em `%a.d.`. Então vou pegar uns valores para ver o que acontece:

```{r, warning = FALSE, message = FALSE}
selic_11   <- BETS.get("11",   from = "2000-01-01", to = "2017-12-31")
#head(selic_11)
selic_4390 <- BETS.get("4390", from = "2000-01-01", to = "2017-12-31")
#head(selic_4390)

df1 <- as.data.frame(selic_11)
#head(df1)

p1 <- ggplot(df1, aes(date, value)) +
        geom_line() +
        scale_x_date() +
        xlab("Data") +
        ylab("Selic (%a.d.)") +
        ggtitle("11 - Taxa de Juros - Selic")


df2 <- data.frame(time(selic_4390), as.numeric(selic_4390))
#head(df2)
names(df2) <- c("date", "value")

p2 <- ggplot(df2, aes(date, value)) +
        geom_line() +
        xlab("Data") +
        ylab("Selic (%a.m.)") +
        ggtitle("4390 - Taxa de Juros - Selic acumulada no mês")

grid.arrange(p1, p2, ncol=1, nrow = 2)
```

Peguei ambas séries de janeiro de 2017 a dezembro de 2017 e na série diária eu somei os valores de cada mês, para obter 12 valores e comparei com os 12 valores da série `4390`. Os valores são bem similares. Depois eu tentei fazer um puxadinho do que é a fórmula nos dados básicos da série `4390`, onde diz `CONVPER((ACMVALORES(((SERIE(11)/100)+1),"mensal","multiplicacao")-1)*100,"mensal","ultimovalor")`. O que eu fiz no Excel foi pegar cada valor, dividir por $100$ e somar $1$. Depois disso, multipliquei os valores dentro de um mesmo mês, subtraí $1$ e multipliquei por $100$.

![Comparação da série 11 com a série 4390](C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Selic.png)

Resumindo, o que tem na série `4390` parece ser a fórmula de juros compostos usando os valores da série `11`, que por sua vez tem valores do tipo "escadinha". 

Agora, eu olhei para a Selic Overnight, do site do IPEA.

```{r, echo = FALSE}
# Vou deixar ele escondido por enquanto
selic_bacen <- BETS.get("4390", from = "1994-07-01", to = "2017-11-01")

plot(selic_bacen) # depois tem que passar para anual

selic_overnight <- read.csv2("C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\selic_overnight.csv", sep = ";", dec = ",", header = TRUE)
selic_overnight <- selic_overnight[,-3]
colnames(selic_overnight) <- c("Data", "Selic")

# Arrumando as datas
selic_overnight[,1]<-paste(selic_overnight[,1], ".01", sep="")
selic_overnight[,1]<-ymd(selic_overnight[,1])

inicio <- which(selic_overnight[,1] == "1994-07-01")
fim <- which(selic_overnight[,1] == "2017-11-01")
selic_overnight<-selic_overnight[inicio:fim,]

selic_overnight <- ts(selic_overnight[,2],  start = c(1994, 7, 1), frequency = 12)

plot(selic_overnight)

# Essas foram tentativas anteriores de fazer o VAR
#var1 <- cbind(selic_bacen, capital_trabalho_adj)
#var2 <- cbind(selic_overnight, capital_trabalho_adj)
```

```{r, message = FALSE, warning = FALSE}
selic_overnight <- read.csv2("C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\selic_overnight.csv", sep = ";", dec = ",", header = TRUE)
selic_overnight <- selic_overnight[,-3]
colnames(selic_overnight) <- c("Data", "Selic")

# Arrumando as datas
selic_overnight[,1]<-paste(selic_overnight[,1], ".01", sep="")
selic_overnight[,1]<-ymd(selic_overnight[,1])

inicio <- which(selic_overnight[,1] == "1994-07-01")
fim <- which(selic_overnight[,1] == "2017-11-01")
selic_overnight<-selic_overnight[inicio:fim,]

p3 <- ggplot(selic_overnight, aes(Data, Selic)) +
        geom_line() +
        xlab("Data") +
        ylab("Selic (%a.m.)") +
        ggtitle("Taxa de Juros - Overnight Selic")

grid.arrange(p1, p2, p3, ncol=1, nrow = 3)
```

Eu estou desconfiada que a Overnight do IPEA e a série `4390` são a mesma coisa, então vou dropar uns valores da overnight e ver o que acontece.

```{r, warning = FALSE, message = FALSE}
inicio <- which(selic_overnight[,1] == "2000-01-01")
fim <- which(selic_overnight[,1] == "2017-11-01")
selic_overnight_menor<-selic_overnight[inicio:fim,]

p4 <- ggplot(selic_overnight_menor, aes(Data, Selic)) +
        geom_line() +
        xlab("Data") +
        ylab("Selic (%a.m.)") +
        ggtitle("Taxa de Juros - Overnight Selic")

grid.arrange(p1, p2, p4, ncol=1, nrow = 3)
```

Os gráficos são bem similares... Mas e os valores? (obs: eu olhei para os valores da cauda também e usei janelas maiores de dados... só os dois últimos não são iguais na segunda casa decimal.)

```{r}
cbind(head(round(selic_overnight_menor[,2],2), 10), head(selic_4390[1:(length(selic_4390)-1)], 10))
```

E acho que isso resolve uma parte do mistério. A série `4390` e a série `Selic Overnight` do site do IPEA de fato parecem ser a mesma série. E elas são o resultado da fórmula de juros compostos na série `11`. <span style="color:purple">Aisha:</span> **Agora resta saber por que a série `11` tem formato tão de escadinha.**

Como é mais fácil de pegar os dados usando o pacote BETS, eu vou usar a série `selic_4390` como a série "oficial". Agora resta baixar os dados da série inteira (jul-94 até dez-17) e anualizar.

```{r, warning = FALSE, message = FALSE}
selic_4390 <- BETS.get("4390", from = "1994-07-01", to = "2017-12-31") 

## Transformando em série anual
selic <- ((1+selic_4390/100)^(12)-1)*100
#head(selic)
#tail(selic)
#length(selic)

df2 <- data.frame(time(selic), as.numeric(selic))
names(df2) <- c("Data", "Selic")

p5 <- ggplot(df2, aes(Data, Selic)) +
        geom_line() +
        xlab("Data") +
        ylab("Selic (%a.a.)") +
        ggtitle("Taxa de Juros - Selic (%a.a.)")

p5
```

Os valores do início da série estão meio ruins, mas depois eu me preocupo com isso se for o caso. Tem outra coisa me incomodando que os valores estão meio diferentes do que tem no site do Bacen: https://www.bcb.gov.br/Pec/Copom/Port/taxaSelic.asp. _**Aí não sei se eu não fiz merda na hora de converter a taxa.**_

**Fim da digressão sobre a SELIC**

## Pegando os outros dados

As variáveis do modelo do Mumtaz são:

* PIB per capita (_real GDP per capita_) - peguei IBC-Br `24364` que já tem ajuste sazonal (problema é que a série começa em janeiro de 2003 e acaba em outubro de 2017). Depois acabei pegando o `PIB Mensal` do [Ipea Data](http://www.ipeadata.gov.br/Default.aspx) deflacionado usando o IPCA de novembro de 2017. Essa deflação é feita com alguma bruxaria que não consegui identificar e por isso estou carregando o arquivo csv - não deu para baixar as séries do Bacen e deflacionar eu mesma e achar a mesma coisa.
* Inflação (_CPI inflation_) - peguei IPCA `433` que já está em variação percentual mensal;
* _Three month treasury bill rate_ - falei com o Portela e ele sugeriu usar a série `7818` _Taxa referencial de swaps DI pré-fixada (BM&F) - Prazo de 90 dias (fim de período)_ (ela tem valores de 30/09/1999 a desembro de 2017). Depois comparei com a selic e como são praticamente iguais, fiquei com a Selic, mas fiz um teste com ela.
* Taxa de crescimento da taxa de câmbio efetiva nominal (_growth of the nominal effective exchange rate_) - mínima ideia de como calcular isso também. Peguei a série que o Portela usava em séries temporais: `3696` - taxa de câmbio livre - dólar americano (venda) fim de período mensal.

Todas as variáveis exceto as de desigualdade, inflação e a taxa de juros estão em _log differences_ (diferença dos logaritmos).

### PIB

Bom, não tem PIB per capita, primeiro pensei em usar IBC-Br.

```{r, message = FALSE, warning = FALSE}
ibcbr <- BETS.get("24364", from = "2003-09-01", to = "2017-12-31") 

df3 <- data.frame(time(ibcbr), as.numeric(ibcbr))
names(df3) <- c("Data", "IBCBr")

p6 <- ggplot(df3, aes(Data, IBCBr)) +
        geom_line() +
        xlab("Data") +
        ylab("IBC-Br") +
        ggtitle("Índice de Atividade Econômica do Bacen - com ajuste sazonal")

p6
```

<span style="color:red">LEMBRETE:</span> ~~Esse trem tem uma tendência monstra, depois tem que ver isso.~~ Tirei a diferença da série em log.

<span style="color:red">LEMBRETE:</span> ~~A série começa em janeiro de 2003... Daí fica com 178 dados... tem que ver com o Guilherme depois.~~ <span style="color:blue">Update:</span> Usei o PIB mensal e ele deixou.

#### PIB Mensal

Fuçando no site do Banco Central, eu achei uma série chamada `PIB mensal - Valores correntes (R$ milhões)` (4380).

Vou dar uma olhada nela:

```{r}
PIBmensal <- BETS.get("4380", from = "1994-07-01", to = "2017-12-31") 
data1 <- seq(as.Date("1994-07-01"), length = length(PIBmensal), by = "1 month")

df3 <- data.frame(data1, as.numeric(PIBmensal))

p6 <- ggplot(df3, aes(data1, PIBmensal)) +
        geom_line() +
        xlab("Data") +
        ylab("PIB Mensal (R$ milhões)") +
        ggtitle("PIB mensal - Valores correntes")

p6

# Como eu estou com preguiça de calcular o PIB deflacionado, peguei a série do site do IPEA pronta deflacionada pelo IPCA bonitinha

PIBmensal2 <- read.csv("C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\PIBmensal.csv", header = T, sep = ";", dec = ",")
data1 <- seq(as.Date("1994-07-01"), length = nrow(PIBmensal2), by = "1 month")

df3 <- data.frame(data1, as.numeric(PIBmensal))
names(df3) <- c("Data", "PIBmensal")

p6 <- ggplot(df3, aes(Data, PIBmensal)) +
        geom_line() +
        xlab("Data") +
        ylab("PIB Mensal (R$ milhões)") +
        ggtitle("PIB mensal - Valores reais (base IPCA 11/2017)")

p6 + scale_y_continuous(labels = comma)

# Agora preciso transformar em índice
PIBmensal_in <- (PIBmensal/PIBmensal[1])*100
df3 <- data.frame(data1, as.numeric(PIBmensal_in))
names(df3) <- c("Data", "PIBmensal")

p6 <- ggplot(df3, aes(Data, PIBmensal)) +
        geom_line() +
        xlab("Data") +
        ylab("PIB Mensal") +
        ggtitle("PIB mensal índice - base = 2004/07")

p6

ibcbr <- BETS.get("24364", from = "2003-01-01", to = "2017-10-31")
data2 <- seq(as.Date("2003-01-01"), length = length(ibcbr), by = "1 month")

df4 <- data.frame(data2, as.numeric(ibcbr))
names(df4) <- c("Data", "IBCBr")

# Tentando juntar os pontos
test1 <- melt(data = df3, id.vars = "Data")
test2 <- melt(data = df4, id.vars = "Data")

test <- rbind(test1, test2)

ggplot(test, aes(Data, value, colour = variable)) +
  geom_line(alpha = 1)+
  labs(title="IBC-Br x PIB mensal", y = "", x= "Tempo", color = "Variável") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw()

PIBmensal_in <- ts(PIBmensal_in,  start = c(1994, 07, 01), frequency = 12) 

```

<span style="color:blue">Update:</span> Eu fiz alguns testes e o VAR com o PIB mensal "deu bom". Como _é importante saber fazer no mínimo o que um aluno graduado em economia faz_ (MOURA, 2018), vou refazer as coisas em cima deflacionando eu mesma a série. Peguei um tutorial [aqui](https://analisemacro.com.br/economia/inflacao/como-deflacionar-uma-serie/). <span style="color:blue">Update:</span> ~~**Essa merda não funciona, vou continuar na ignorância mesmo, aff.**~~ <span style="color:blue">Update:</span> Havia um erro na merda da série do IPCA do IPEA data e aí os resultados entre o que eu calculava no Excel e o que tinha no Bacen davam diferentes. Eu e o Cássio mandamos um e-mail pro IPEA avisando. E agora eu consigo fazer tudo sem usar um csv. :D

Pra Aisha do futuro, eu tentei usar a fórmula e os valores deram diferentes do site do IPEA. Aí lendo as [notas metodológicas](http://www.ipeadata.gov.br/iframe_transformacao.aspx?width=1474&height=701#Deflacionamento), fala isso aqui: " _Os índices IPCA, INPC e IGP-DI refletem o nível de preços médios de cada período, sendo inadequados para deflacionar séries referentes ao final do período. Visando minimizar tal problema, o sistema calcula esses índices de preço no final de cada período através do cálculo da média geométrica entre o índice do período e o índice do período seguinte._" Calcular a média geométrica é tirar a raiz quadrada do produto, ~~mas quando o índice dá negativo, dá ruim. Aí tentei fazer a média geométrica do IPCA acumulado, também não deu e eu desisti porque não tá sobrando tanto tempo assim.~~ Agora deu.

```{r, warning = FALSE, message = FALSE}
PIBmensal <- BETS.get("4380", from = "1999-06-01", to = "2017-11-30") 
data1 <- seq(as.Date("1994-07-01"), length = length(PIBmensal), by = "1 month")
df3 <- data.frame(data1, as.numeric(PIBmensal))
names(df3) <- c("Data", "PIBmensal")

p6 <- ggplot(df3, aes(Data, PIBmensal)) +
        geom_line() +
        xlab("Data") +
        ylab("PIB Mensal (R$ milhões)") +
        ggtitle("PIB mensal - Valores correntes")
p6

# O IPCA tem que ser pego desde 1993 caso queira confrontar com os valores do IPEA Data
ipca <- BETS.get("433", from = "1993-12-31", to = "2017-12-31") 
ipca2 <- ipca
ipca2[1] <- 100

# Transformar em índice
for (i in 2:length(ipca2)){
  ipca2[i] <- round(ipca2[(i-1)]*(1+ipca2[(i)]/100),2)
}

# Média geométrica
for (i in 1:(length(ipca2)-1)){
  ipca2[i] <- sqrt(ipca2[i]*ipca2[(i+1)])
}

ipca2 <- ipca2[1:(length(ipca2)-1)]

# Mudança para base de nov/2017
for (i in 1:length(ipca2)) {
  ipca2[i] <- tail(ipca2, n=1)/ipca2[i]
}

# Tirando as observações que não quero
ipca2 <- ts(ipca2,  start = c(1993, 12, 31), frequency = 12)
ipca2 <- window(ipca2, c(1996, 6))

PIBmensal <- PIBmensal*ipca2
```

### Inflação

Para inflação usei a série `433`, do IPCA. Tem duas coisas que podem ser feitas, uma é calcular o índice acumulado no ano (o que não parece interessante porque implica que todo início de ano teria uma queda) e a segunda é calcular o índice acumulado nos últimos 12 meses. Para fazer a segunda, tem que primeiro pegar todos os valores da série e dividir por 100 e depois acrescentar 1. Dessa nova série, são multiplicados os 12 valores anteriores (incluindo o atual), desconta um e multiplica por 100.

```{r, message = FALSE, warning = FALSE}
# Primeiro um gráfico simples
ipca <- BETS.get("433", from = "1994-07-01", to = "2017-12-31") 

df4 <- data.frame(time(ipca), as.numeric(ipca))
names(df4) <- c("Data", "IPCA")

p7 <- ggplot(df4, aes(Data, IPCA)) +
        geom_line() +
        xlab("Data") +
        ylab("IPCA") +
        ggtitle("Inflação (IPCA) - mensal")

p7

# Agora a inflação acumulada em 12 meses
ipca_acum <- ipca/100 + 1
ipca_acum2 <- vector()

for (i in 12:282){
  ipca_acum2[(i-11)] <- (prod(ipca_acum[(i-11):i])-1)*100
}
ipca_acum2 <- ts(ipca_acum2,  start = c(1995, 6, 1), frequency = 12)

df4 <- data.frame(time(ipca_acum2), as.numeric(ipca_acum2))
names(df4) <- c("Data", "IPCA")

p8 <- ggplot(df4, aes(Data, IPCA)) +
        geom_line() +
        xlab("Data") +
        ylab("IPCA") +
        ggtitle("Inflação (IPCA) - acumulada 12 meses")

p8

```

Eu conferi os valores com [isso aqui](http://www.valor.com.br/brasil/5110008/ipca-desacelera-em-agosto-e-completa-12-meses-consecutivos-de-queda) e bateu. <span style="color:grey">~~Já posso pedir a carteirinha de economista, yay!~~</span> ~~Posso nada, não consegui deflacionar o PIB.~~ CONSEGUI, mwahahah.

<span style="color:purple">Aisha:</span>  **De novo tem aquelas valores ruins no início da série, acho que vou ter mesmo que eliminar uns valores.**

### Three month treasury bill rate

Depois de falar com o Portela, cheguei nessa série aqui: `7818` _Taxa referencial de swaps DI pré-fixada (BM&F) - Prazo de 90 dias (fim de período)_ . ~~Eu ainda não sei como que isso se relaciona a uma taxa de juros (no sentido de instrumento de política monetária), mas vou deixar os dados aqui guardados por enquanto.~~ <span style="color:blue">Update:</span> O Guilherme disse que por essa série ser mais "suave", ela acaba sendo mais utilizada nos trabalhos. Fui ver e além do Mumtaz, o Primiceri e o Cogley e Sargent usam também.

```{r, message = FALSE, warning = FALSE}
swap90 <- BETS.get("7818", from = "1999-09-01", to = "2017-12-31")

df7 <- data.frame(seq(as.Date("1999-09-01"), length = length(swap90), by = "1 month"), as.numeric(swap90))
names(df7) <- c("Data", "DI90")

p10 <- ggplot(df7, aes(Data, DI90)) +
        geom_line() +
        xlab("Data") +
        ylab("DI90 (%a.a.)") +
        ggtitle("Taxa referencial de swaps DI pré 3 meses - fim de período")

p10
```

Vou tentar comparar com a SELIC. **Será que essas duas taxas são comparáveis?** _Acho que sim porque eu passei SELIC para %a.a. também..._. 

```{r, message = FALSE, warning = FALSE}
selic_4390 <- BETS.get("4390", from = "1999-09-01", to = "2017-12-31") 

## Transformando em série anual
selic <- ((1+selic_4390/100)^(12)-1)*100
df10 <- data.frame(seq(as.Date("1999-09-01"), length = length(selic), by = "1 month"), as.numeric(selic))
names(df10) <- c("Data","Selic")
p11 <- ggplot(df10, aes(Data, Selic)) +
        geom_line() +
        xlab("Data") +
        ylab("Selic (%a.a.)") +
        ggtitle("Selic")

grid.arrange(p10, p11, ncol=1, nrow = 2)

df8 <- data.frame(df7, selic)
names(df8) <- c("Data", "Swap", "Selic")

df9 <- melt(data = df8, id.vars = "Data")

p9 <- ggplot(df9, aes(Data, value, colour = variable)) +
  geom_line(alpha = 1, aes(linetype = variable))+
  labs(title="", y = "Taxa (%a.a.)", x= "Ano", color = "Taxa") +
  scale_colour_brewer(palette = "Set1") +
  scale_x_date(date_breaks = "1 year", name = "Ano", labels = date_format("%Y"))+
  theme_bw()

p9 <- p9 + labs(linetype = "Taxa") 
p9 <- p9 + labs(colour='Taxa') 
p9 <- p9 + theme(legend.position="top", legend.key.size = unit(.5, "cm"), axis.text.x = element_text(angle=25, hjust = 1, size = 7), axis.title.y = element_text(size = 7), axis.title.x = element_text(size = 7))

# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-Swap_Selic.pdf", width = 6, height = 3)
p9
#dev.off()

head(df8)

cor.test(df8[complete.cases(df8),][,2], df8[complete.cases(df8),][,3], method = "spearman", conf.level = 0.05)

teste_1<-round(cor.test(df8[complete.cases(df8),][,2], df8[complete.cases(df8),][,3], method = "spearman", conf.level = 0.05)[[4]],4)
p_valor1 <- round(cor.test(df8[complete.cases(df8),][,2], df8[complete.cases(df8),][,3], method = "spearman", conf.level = 0.05)[[3]],4)
```

~~Elas são praticamente iguais, então vou ficar com a Selic.~~ <span style="color:blue"> Update (18/01/2018) </span> Guilherme mandou ficar com o swap DI.  <span style="color:blue"> Update (22/01/2018) </span> Agora que vi que essa coisa começa só em 99. <span style="color:blue"> Update (2?/01/2018) </span> Completei a série com a Selic para montar minha priori.

### Câmbio

Do câmbio, tem essas séries no Bacen:

* **Taxa de câmbio - Livre - Dólar americano (compra) - Média de período - mensal**: número da série 3697, peridiocidade mensal, unidade u.m.c./US$.
* **Taxa de câmbio - Livre - Dólar americano (venda) - Fim de período - mensal**: número da série 3696, peridiocidade mensal, unidade u.m.c./US$.

Como o Portela usa a segunda, vou usar a segunda (argumento de autoridade).

```{r, warning = FALSE, message = FALSE}
cambio <- BETS.get("3696", from = "1994-07-01", to = "2017-12-31")

df5 <- data.frame(time(cambio), as.numeric(cambio))
names(df5) <- c("Data", "Cambio")

p8 <- ggplot(df5, aes(Data, Cambio)) +
        geom_line() +
        xlab("Data") +
        ylab("Tx. de Câmbio (u.m.c./US$)") +
        theme_bw() +
        ggtitle("Taxa de câmbio - Dólar americano (venda) - Fim de período - mensal")

p8
```

Realmente a partir de 99 que as coisas começaram a ficar diferentes.

Vou tentar calcular a taxa de crescimento usando a diferença dos logaritmos.

```{r, warning = FALSE, message = FALSE}
cambio_cres <- diff(log(cambio), 1)

df6 <- data.frame(time(cambio_cres), as.numeric(cambio_cres))
names(df6) <- c("Data", "Cambio")

p9 <- ggplot(df6, aes(Data, Cambio)) +
        geom_line() +
        xlab("Data") +
        ylab("Variação") +
        ggtitle("Taxa de variação da Taxa de câmbio - Dólar americano (venda) - Fim de período - mensal")

p9
```

### Ibovespa

Aí como estava com tempo sobrando, pensei em pegar o Ibovespa. Teoricamente teria alguma relação entre preço dos ativos e taxa de juros <span style="color:blue"> Update (18/01/2018) </span> Guilherme me deu um toco e mandou não usar.

```{r}
symbols <- c("^BVSP")
getSymbols(symbols, src = 'yahoo', from = "1996-01-01", 
             auto.assign = TRUE, warnings = FALSE) 
prices <- merge(BVSP)
prices <- prices[,grepl( "Close" , names(prices) )]
colnames(prices) <- symbols
returns <- na.omit(monthlyReturn(prices, type = "log"))
plot.xts(returns)

ibovespa <- ts(returns, start = c(1996,1,1), frequency = 12)

df1 <- data.frame(seq(as.Date("1996-01-01"), length = length(ibovespa), by = "1 month"), ibovespa)
names(df1) <- c("Data", "Ibovespa")

p9 <- ggplot(df1, aes(Data, Ibovespa)) +
        geom_line() +
        xlab("Data") +
        ylab("Ibovespa") +
        scale_x_date(date_breaks = "12 months")+
        ggtitle("Log retornos mensais do Ibovespa")

p9 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 6), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))
```

<span style="color:blue"> Update (22/01/2018) </span> Guilherme mandou deixar de fora. :(

## Todos os dados juntos

A lista de dados que tenho até agora é:

1. Razão capital-trabalho (para desigualdade), calculada a partir das seguintes séries:
    * **Renda do trabalho**: `Receitas tributárias - Regime de competência - Imposto de renda - Retido na fonte - Rendimento do trabalho (7620)`
    * **Renda do capital**: `Receitas tributárias - Regime de competência - Imposto de renda - Retido na fonte - Rendimento do capital (7621)`
Não foi feita nenhuma transformação nos dados.

2. Taxa _three month treasury bill rate_) calculada a partir da série:
    * `Taxa de juros - Selic acumulada no mês (4390)`
Eu comparei com a taxa referencial de swaps DI pré-fixada e ambas são praticamente a mesma coisa, ~~então fiquei com a Selic mesmo~~. A única transformação feita (até agora) foi passar de taxa mensal para anual usando a fórmula: $\left((1+tx/100)^12 -1\right)*100$.

    *  `Taxa referencial de swaps DI pré-fixada (BM&F) - Prazo de 90 dias (fim de período) (7818)` Sem transformação (a taxa já é ao ano). O problema é que essa série começa apenas em 1999.

3. IPCA (para inflação), utilizando a seguinte série:
    * `Índice nacional de preços ao consumidor-amplo (IPCA) (433)`
Como ele está em variação percentual mensal, foi necessário transformar para acumulado dos últimos 12 meses utilizando a fórmula: $$IPCA_i = \left[\left(\prod\limits_{j=i-11}^i \left(\frac{IPCA_j}{100}+1\right) \right) -1\right]*100$$

4. Para o PIB per capita
    * IBC-Br (para o PIB per capita), utilizando a seguinte série:
          * `	Índice de Atividade Econômica do Banco Central (IBC-Br) - com ajuste sazonal (24364)`
~~Não fiz nenhuma transformação por enquanto, mas o bicho tem uma baita tendência.~~ Fiz a diferença da série em log, igual o câmbio.

    * PIB mensal (retirado do site do IPEA) deflacionado usando o IPCA de novembro de 2017.
Fiz a diferença da série em log, igual o câmbio.

5. Crescimento da taxa de câmbio (para _growth of the nominal effective exchange rate_). Usei a série:
    * `Taxa de câmbio - Livre - Dólar americano (venda) - Fim de período - mensal (3696)`
Como o Mumtaz disse que usou log diferença, eu calculei o log e tirei primeira diferença nessa série. ~~As outras eu ainda não fiz, porque o IBC-Br é índice e a inflação também...~~

```{r, message = FALSE, warning = FALSE, eval = FALSE}
rm(list = ls())

# Auxiliary variables, so I don't need to bother when something changes
inicio <- "2003-02-01"
fim    <- "2017-10-31"

# Don't mess with this code
inicio_cambio <- paste(seq(as.Date(inicio), length = 2, by = "-1 month")[2]) # 1 mês antes do início das outras séries
inicio_ipca   <- paste(seq(as.Date(inicio), length = 12, by = "-1 month")[12]) # 12 meses antes do início das outras séries

trabalho <- BETS.get("7620", from = inicio, to = fim)
capital  <- BETS.get("7621", from = inicio, to = fim)
capital_trabalho <- capital/trabalho

# Usando ndiffs(ibcbr,test="adf",alpha = 0.1) se encontra que o ibcbr é não estacionário.
# Como todas as outras séries são estacionárias, eu vou fazer também a diferença do log, igual no câmbio
ibcbr_raw    <- BETS.get("24364", from = inicio_cambio, to = fim)
ibcbr        <- diff(log(ibcbr_raw), 1)

cambio_raw <- BETS.get("3696", from = inicio_cambio, to = fim)
cambio     <- diff(log(cambio_raw), 1)

selic_4390 <- BETS.get("4390", from = inicio, to = fim) 
selic <- ((1+selic_4390/100)^(12)-1)*100

ipca_raw <- BETS.get("433", from = inicio_ipca, to = fim) 
ipca_acum <- ipca_raw/100 + 1
ipca <- vector()

final <- length(ipca_acum)
for (i in 12:final){
  ipca[(i-11)] <- (prod(ipca_acum[(i-11):i])-1)*100
}

ano <- as.numeric(substr(inicio, start = 1, stop = 4))
mes <- as.numeric(substr(inicio, start = 6, stop = 7))
dia <- as.numeric(substr(inicio, start = 9, stop = 10))

ipca <- ts(ipca,  start = c(ano, mes, dia), frequency = 12) # Date format YYYY MM DD

# Plotting some nice graphs

df1 <- data.frame(seq(as.Date(inicio), length = length(ipca), by = "1 month"), capital_trabalho, selic, ibcbr, cambio, ipca)
names(df1) <- c("Data", "Capital_trabalho", "Selic", "IBCBr", "Cambio", "IPCA")
df2 <- melt(data = df1, id.vars = "Data")


ggplot(df2, aes(Data, value, colour = variable)) +
  geom_line(alpha = 1)+
  labs(title="Variáveis do modelo", y = "", x= "Time", color = "Variável") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw()

cores <- brewer.pal(5, "Dark2")

# Gráficos individuais
p1 <- ggplot(df2[which(df2$variable == "Capital_trabalho"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[1])+
        scale_y_continuous(name="Capital trabalho") +
        scale_x_date(date_breaks = "12 months")+ 
        theme_bw()
p1 <- p1 + theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 8))

p2 <- ggplot(df2[which(df2$variable == "Selic"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[2])+
        scale_y_continuous(name="Selic") +
        scale_x_date(date_breaks = "12 months")+ 
        theme_bw()
p2 <- p2 + theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 8))

p3 <- ggplot(df2[which(df2$variable == "IBCBr"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[3])+
        scale_y_continuous(name="IBC-Br") +
        scale_x_date(date_breaks = "12 months")+
        theme_bw()
p3 <- p3 + theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 8))

p4 <- ggplot(df2[which(df2$variable == "Cambio"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[4])+
        scale_y_continuous(name="Tx. Câmbio (var)") +
        scale_x_date(date_breaks = "12 months")+
        theme_bw()
p4 <- p4 + theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 8))

p5 <- ggplot(df2[which(df2$variable == "IPCA"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[5])+
        scale_y_continuous(name="IPCA") +
        scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%Y"))+
        theme_bw()
p5 <- p5 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 6), axis.title.x = element_blank(), axis.title.y = element_text(size = 8))

grid.arrange(p1, p2, p3, p4, p5, ncol=1, nrow = 5)
```

Acrescentando o PIB e o Swap DI 3 meses:

```{r, message = FALSE, warning = FALSE}
#rm(list = ls())

# Auxiliary variables, so I don't need to bother when something changes
inicio <- "1996-01-01"
fim    <- "2017-11-30"
inicio_deflator <- "1993-12-31"

# Don't mess with this code
inicio_cambio <- paste(seq(as.Date(inicio), length = 2, by = "-1 month")[2]) # 1 mês antes do início das outras séries
inicio_ipca2   <- paste(seq(as.Date(inicio), length = 12, by = "-1 month")[12]) # 12 meses antes do início das outras séries
fim_ipca      <- paste(seq(as.Date(fim), length = 2, by = "1 month")[2]) # 1 mês depois do fim das outras séries

trabalho <- BETS.get("7620", from = inicio, to = fim)
capital  <- BETS.get("7621", from = inicio, to = fim)
capital_trabalho <- capital/trabalho

ipca_raw <- BETS.get("433", from = inicio_deflator, to = fim_ipca) 
ipca2 <- ipca_raw
ipca2[1] <- 100

# Transformar em índice
for (i in 2:length(ipca2)){
  ipca2[i] <- round(ipca2[(i-1)]*(1+ipca2[(i)]/100),2)
}

# Média geométrica
for (i in 1:(length(ipca2)-1)){
  ipca2[i] <- sqrt(ipca2[i]*ipca2[(i+1)])
}

# Mudança para base de nov/2017
for (i in 1:length(ipca2)) {
  ipca2[i] <- tail(ipca2, n=2)[1]/ipca2[i]
}

# Tirando as observações que não quero
ipca2 <- ts(ipca2,  start = c(1993, 12, 31), frequency = 12)
ano_ipca <- as.numeric(substr(inicio_cambio, start = 1, stop = 4))
mes_ipca <- as.numeric(substr(inicio_cambio, start = 6, stop = 7))
ipca2 <- window(ipca2, c(ano_ipca, mes_ipca))

ano_ipca <- as.numeric(substr(inicio_ipca2, start = 1, stop = 4))
mes_ipca <- as.numeric(substr(inicio_ipca2, start = 6, stop = 7))
ipca_raw <- window(ipca_raw, c(ano_ipca, mes_ipca))
# Tira dezembro 2017
ipca_raw <- ipca_raw[1:(length(ipca_raw)-1)]

ipca_acum <- ipca_raw/100 + 1
ipca <- vector()

final <- length(ipca_acum)
for (i in 12:final){
  ipca[(i-11)] <- (prod(ipca_acum[(i-11):i])-1)*100
}

ano <- as.numeric(substr(inicio, start = 1, stop = 4))
mes <- as.numeric(substr(inicio, start = 6, stop = 7))
dia <- as.numeric(substr(inicio, start = 9, stop = 10))

ipca <- ts(ipca,  start = c(ano, mes, dia), frequency = 12) # Date format YYYY MM DD

# Usando ndiffs(PIBmensal,test="adf",alpha = 0.05) se encontra que o PIBmensal é não estacionário.
# Como todas as outras séries são estacionárias, eu vou fazer também a diferença do log, igual no câmbio
PIBmensal <- BETS.get("4380", from = inicio_cambio, to = fim)
PIBmensal <- PIBmensal * ipca2 
PIB <- diff(log(PIBmensal), 1)

cambio_raw <- BETS.get("3696", from = inicio_cambio, to = fim)
cambio     <- diff(log(cambio_raw), 1)

swap90 <- BETS.get("7818", from = inicio, to = fim)
swap90 <- ts.union(swap90, ipca)
swap90 <- swap90[,1]

selic_4390 <- BETS.get("4390", from = inicio, to = fim) 
selic <- ((1+selic_4390/100)^(12)-1)*100

# Plotting some nice graphs

df1 <- data.frame(seq(as.Date(inicio), length = length(ipca), by = "1 month"), capital_trabalho*100, swap90, PIB*100, cambio*100, selic, ipca)
names(df1) <- c("Data", "Capital_trabalho", "Swap90", "PIB", "Cambio", "selic", "IPCA")
df2 <- melt(data = df1, id.vars = "Data")

ggplot(df2, aes(Data, value, colour = variable)) +
  geom_line(alpha = 1)+
  labs(title="Variáveis do modelo", y = "", x= "Time", color = "Variável") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw()

cores <- brewer.pal(6, "Dark2")

scaleFUN  <- function(x) sprintf("%.1f", x)
scaleFUN2 <- function(x) sprintf("%.3f", x)

# Gráficos individuais
p1 <- ggplot(df2[which(df2$variable == "Capital_trabalho"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[1])+
        scale_y_continuous(name="Capital trabalho\n", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months")+ 
        theme_bw()
p1 <- p1 + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p2 <- ggplot(df2[which(df2$variable == "Swap90"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[2])+
        scale_y_continuous(name="Swap\n (%a.a.)", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months")+ 
        theme_bw()
p2 <- p2 + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p3 <- ggplot(df2[which(df2$variable == "PIB"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[3])+
        scale_y_continuous(name="PIB\n (var. % mensal)", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months", name = "Data", labels = date_format("%Y"))+
        theme_bw()
p3 <- p3 + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

#p3 <- p3 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 6), axis.title.x = element_blank(), axis.title.y = element_text(size = 8))

p4 <- ggplot(df2[which(df2$variable == "Cambio"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[4])+
        scale_y_continuous(name="Câmbio\n (var. % mensal)", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months", name = "Ano", labels = date_format("%Y"))+
        theme_bw()
p4 <- p4 + theme(axis.text.y = element_text(size = 6), axis.text.x = element_text(angle=25, hjust = 1, size = 6), axis.title.x = element_text(size = 6), axis.title.y = element_text(size = 6), plot.margin = unit(c(0.009,0.08,0.0001,0.1), "cm"))

p5 <- ggplot(df2[which(df2$variable == "selic"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[5])+
        scale_y_continuous(name="Selic\n (%a.a.)") +
        scale_x_date(date_breaks = "24 months")+
        theme_bw()
p5 <- p5 + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p6 <- ggplot(df2[which(df2$variable == "IPCA"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[5])+
        scale_y_continuous(name="IPCA\n (acum. 12m.)", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months", name = "Ano", labels = date_format("%Y"))+
        theme_bw()
p6 <- p6 + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

grid.arrange(p1, p2, p4, p5, p3, p6, ncol=2, nrow = 3)

grid.arrange(p1, p4, p3, ncol=1, nrow = 3)

grid.arrange(p2, p5, p6, ncol = 1, nrow = 3)

# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-Séries_sem_ajuste.pdf", width = 6, height = 6)
grid.arrange(p1, p6, p3, p2, p4, ncol=1, nrow = 5)
#dev.off()



```

# A sazonalidade

Agora começa outro problema para tratar os dados: para a razão capital trabalho original, tem 30 observações de antes do plano real que tem valores muito altos. Depois de eliminar elas, tem duas séries com tendência e sazonalidade. A razão entre elas não aparenta ter tendência (fiz um teste que indicou que a série precisaria de uma diferença para ficar estacionária), porém parece ter uma componente sazonal persistente.

~~Resolvi tentar duas coisas: a primeira foi fazer manualmente a remoção de tendência e sazonalidade e a segunda foi usar um filtro pronto.~~ Meu filtro manual ficou uma merda, então vou ficar com o automático mesmo.


## Procedimento manual

Vou deixar aqui e qualquer coisa apago no final. Os chunks não estão sendo rodados.
Usei este tutorial - https://anomaly.io/seasonal-trend-decomposition-in-r/.

### Removendo tendência

Não sei se precisa. Como os dados são mensais, vou usar uma janela móvel de tamanho 12.

```{r, eval = FALSE}
# Checa número de diferenciações necessárias para tornar séries estacionárias
ndiffs(capital_trabalho,test="adf",alpha = 0.1)
# De acordo com o teste, seria necessário diferenciar uma vez a série para que ela fique estacionária

# Remove a tendência ajustando uma janela móvel
trend_capital_trabalho = ma(capital_trabalho, order = 12, centre = T)
plot(as.ts(capital_trabalho))
lines(trend_capital_trabalho)
plot(as.ts(trend_capital_trabalho))

df <- as.data.frame(cbind(time(trend_capital_trabalho),trend_capital_trabalho, capital_trabalho))
head(df)
names(df) <- c("Data", "Tendencia", "CapitalTrabalho")
ggplot(df, aes(Data)) +
  geom_line(aes(y = CapitalTrabalho, colour = "Capital/Trabalho")) +
  geom_line(aes(y = Tendencia, colour = "Tendência")) 
```

### Removendo sazonalidade

```{r, eval = FALSE}
m_capital_trabalho = t(matrix(data = capital_trabalho, nrow = 12))
seasonal_capital_trabalho = colMeans(m_capital_trabalho, na.rm = T)
plot(as.ts(rep(seasonal_capital_trabalho,12)))
```


### Residual

Vamos calcular o "random noise" usando $Resíduo = Série - Sazonalidade - Tendência$.

```{r, eval = FALSE}
residuo = capital_trabalho - seasonal_capital_trabalho - trend_capital_trabalho
plot(as.ts(residuo))
```

Ainda assim está meio estranho... Vou tentar usar um filtro automático.

## X-13ARIMA-SEATS

O X-13ARIMA-SEATS é um algoritmo de ajuste sazonal desenvolvido pelo United States Census Bureau. Sua implementação no R é feita pelo pacote `seasonal`. Um manual pode ser visto aqui: https://cran.r-project.org/web/packages/seasonal/vignettes/seas.pdf. Usei muito este documento aqui: file:///C:/Users/Aishameriane/Desktop/Ferreira_Mattos_2016.pdf e também o teste de quebra estrutural que tem aqui https://pythonandr.com/2016/11/08/endogenously-detecting-structural-breaks-in-a-time-series-implementation-in-r/ .

 <span style="color:blue"> Update (18/01/2018) </span> O Guilherme sugeriu passar um filtro na quebra da razão capital trabalho em 1999. Primeiro vou tirar a sazonalidade da série toda, ver como fica o gráfico, quebrar em dois períodos a série original, depois ajudar o filtro sazonal para cada uma das séries.

```{r}
#######################
# Capital trabalho    #
#######################
cores <- brewer.pal(6, "Dark2")

# Fazendo um teste incluindo os dados desde 1996 (que depois quero fazer o VAR com isso)
trabalho <- BETS.get("7620", from = "1996-01-01", to = "2017-11-01")
capital <- BETS.get("7621", from = "1996-01-01", to = "2017-11-01")
capital_trabalho <- capital/trabalho

m <- seas(x = capital_trabalho, transform.function = "none", regression.aictest = NULL)
qs(m)
plot(m)
summary(m)
sliding <- series(m, "sfs")
sum(sliding[,"Max_._DIFF"] > 3, na.rm = T)/length(na.omit(sliding[,"Max_._DIFF"])) * 100

meses <- ggmonthplot(capital_trabalho) + 
  theme_bw() +
  scale_y_continuous(name = "Razão Capital/Trabalho (% - média)") +
  labs(title = "", x = "Mês", subtitle = "")+
  theme(axis.title = element_text(size = 7), axis.text.x = element_text(angle=25, hjust = 1, size = 7))

# Gráfico por ano e mês
season <- ggseasonplot(capital_trabalho, year.labels = TRUE) + 
          geom_point() + 
          theme_bw() + 
          scale_y_continuous(name = "Razão Capital/Trabalho (% - média)") +
          labs(title = "", x = "Mês", subtitle = "")+
  theme(axis.title = element_text(size = 7), axis.text.x = element_text(angle=25, hjust = 1, size = 7))

# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-Season_CT.pdf", width = 6, height = 3)
season
#meses
#dev.off()

# Usa a interface gráfica
#view(m)

# Salva a série final em uma nova variável
capital_trabalho2 <- final(m)
#plot(capital_trabalho2)

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date("1996-01-01"), length = length(capital_trabalho2), by = "1 month"), capital_trabalho, capital_trabalho2)
names(df) <- c("Data", "Original", "Série Filtrada")
p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = capital_trabalho, colour = "Original")) +
  geom_line(aes(y = capital_trabalho2, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%Y"))+
  scale_y_continuous(name = "Capital/Trabalho")+
  labs(color="Variável") +
  theme_bw() + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 9))
p1

# Dividindo a série em pedaços distintos: 
# pega os pontos de quebras
bp_ts <- breakpoints(capital_trabalho ~ 1)
# o valor com o menor BIC é o escolhido
summary(bp_ts)
# Calcula o intervalo de confiança
ci_ts <- confint(bp_ts)
# Monta o dataframe
Data <- seq(as.Date("1996-01-01"), length = length(capital_trabalho), by = "1 month")
df1 <- melt(data.frame(Data,capital_trabalho), id.vars = "Data")
names(df1) <- c("Data", "Variavel", "Valor")

p1 <- ggplot(df1[which(df1$Variavel == "capital_trabalho"),], aes(Data, Valor, colour = Variavel)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[1])+
        scale_y_continuous(name="Razão Capital/Trabalho") +
        scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+ 
        geom_vline(xintercept = Data[bp_ts$breakpoints], linetype="longdash")+
        geom_segment(aes(x = Data[ci_ts$confint[1]], y = min(capital_trabalho), xend = Data[ci_ts$confint[3]], yend = min(capital_trabalho)))+
        theme_bw()
p1 <- p1 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 6), legend.position = "none")

# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-Quebra_CT.pdf", width = 6, height = 3)
p1
#dev.off()


# Salvando duas séries para passar o seasonal
capital_trabalho_a <- capital_trabalho[1:bp_ts$breakpoints]
capital_trabalho_b <- capital_trabalho[(bp_ts$breakpoints+1):length(capital_trabalho)]
capital_trabalho_a <- ts(capital_trabalho_a,  start = c(1996, 01, 01), frequency = 12)
capital_trabalho_b <- ts(capital_trabalho_b,  start = c(2004, 02, 01), frequency = 12)

m <- seas(x = capital_trabalho_a, transform.function = "none", regression.aictest = NULL)
qs(m)
plot(m)
summary(m)
sliding <- series(m, "sfs")
sum(sliding[,"Max_._DIFF"] > 3, na.rm = T)/length(na.omit(sliding[,"Max_._DIFF"])) * 100
#view(m)

capital_trabalho_2a <- final(m)

ggmonthplot(capital_trabalho_2a) + 
  theme_bw() +
  scale_y_continuous(name = "Razão Capital/Trabalho (% - média)") +
  labs(title = "Média diária e mensal da razão capital-trabalho", x = "Mês", subtitle = "De Jan/96 a Jan/04")

# Gráfico por ano e mês
ggseasonplot(capital_trabalho_2a, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Razão Capital/Trabalho (% - média)") +
  labs(title = "Média mensal da razão capital-trabalho", x = "Mês", subtitle = "De Jan/96 a Jan/04")

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date("1996-01-01"), length = length(capital_trabalho_a), by = "1 month"), capital_trabalho_a, capital_trabalho_2a)
names(df) <- c("Data", "Original", "Série Filtrada")
p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = capital_trabalho_a, colour = "Original")) +
  geom_line(aes(y = capital_trabalho_2a, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+
  scale_y_continuous(name = "Capital/Trabalho")+
  labs(color="Variável") +
  theme_bw() + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 9))
p1

# Dividindo a série em pedaços distintos: 
# pega os pontos de quebras
bp_ts <- breakpoints(capital_trabalho_a ~ 1)
# o valor com o menor BIC é o escolhido
summary(bp_ts)
# Calcula o intervalo de confiança
ci_ts <- confint(bp_ts)


#############
m <- seas(x = capital_trabalho_b, transform.function = "none", regression.aictest = NULL)
qs(m)
plot(m)
summary(m)
sliding <- series(m, "sfs")
sum(sliding[,"Max_._DIFF"] > 3, na.rm = T)/length(na.omit(sliding[,"Max_._DIFF"])) * 100
#view(m)
capital_trabalho_2b <- final(m)

ggmonthplot(capital_trabalho_2b) + 
  theme_bw() +
  scale_y_continuous(name = "Razão Capital/Trabalho (% - média)") +
  labs(title = "Média diária e mensal da razão capital-trabalho", x = "Mês", subtitle = "De Fev/04 a Nov/17")

# Gráfico por ano e mês
ggseasonplot(capital_trabalho_2b, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Razão Capital/Trabalho (% - média)") +
  labs(title = "Média mensal da razão capital-trabalho", x = "Mês", subtitle = "De Fev/04 a Nov/17")

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date("2004-02-01"), length = length(capital_trabalho_b), by = "1 month"), capital_trabalho_b, capital_trabalho_2b)
names(df) <- c("Data", "Original", "Série Filtrada")
p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = capital_trabalho_b, colour = "Original")) +
  geom_line(aes(y = capital_trabalho_2b, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+
  scale_y_continuous(name = "Capital/Trabalho")+
  labs(color="Variável") +
  theme_bw() + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 9))
p1

# Dividindo a série em pedaços distintos: 
# pega os pontos de quebras
bp_ts <- breakpoints(capital_trabalho_b ~ 1)
# o valor com o menor BIC é o escolhido
summary(bp_ts)
# Calcula o intervalo de confiança
#ci_ts <- confint(bp_ts)

###############
# Juntando novamente as duas séries
###############

comb <- ts.union(capital_trabalho_2a, capital_trabalho_2b)
capital_trabalho_final <- pmin(comb[,1], comb[,2], na.rm = TRUE)

cores <- brewer.pal(6, "Dark2")

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date("1996-01-01"), length = length(capital_trabalho_final), by = "1 month"), capital_trabalho, capital_trabalho_final)
names(df) <- c("Data", "Original", "Filtrada")

p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = capital_trabalho, colour = "Original"), linetype = "dashed") +
  geom_line(aes(y = capital_trabalho_final, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Ano", labels = date_format("%Y"))+
  scale_y_continuous(name = "Razão Capital/Trabalho")+
  labs(color="Série") +
  scale_colour_manual("Variável", breaks = c("Original", "Filtrada"), values = c(cores[2], cores[1]))+
  theme_bw() + theme(axis.text.x = element_text(angle=30, hjust = 1, size = 7), legend.position = "top")

# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-AntesDepois_CT.pdf", width = 6, height = 3)
p1
#dev.off()


df <- data.frame(seq(as.Date("1996-01-01"), length = length(capital_trabalho2), by = "1 month"), capital_trabalho,  capital_trabalho2, capital_trabalho_final)
names(df) <- c("Data", "capital_trabalho", "capital_trabalho2", "capital_trabalho_final")
p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = capital_trabalho, colour = "Original")) +
  geom_line(aes(y = capital_trabalho2, colour = "Automático")) +
  geom_line(aes(y = capital_trabalho_final, colour = "Manual")) + 
  scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+
  scale_y_continuous(name = "Razão Capital/Trabalho")+
  labs(color="Método") +
  theme_bw() + theme(axis.text.x = element_text(angle=30, hjust = 1, size = 7))
p1
```

```{r}
#######################
# Selic               #
#######################
cores <- brewer.pal(6, "Dark2")
selic_4390 <- BETS.get("4390", from = "1996-01-01", to = "2017-11-30") 

## Transformando em série anual
selic <- ((1+selic_4390/100)^(12)-1)*100

meses <- ggmonthplot(selic) + 
  theme_bw() +
  scale_y_continuous(name = "Selic (%a.a - média)") +
  labs(title = "", x = "Mês")+
  theme(axis.title = element_text(size = 7), axis.text.x = element_text(angle=25, hjust = 1, size = 7))

# Gráfico por ano e mês
season <- ggseasonplot(selic, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Selic (%a.a. - média)") +
  labs(title = "", x = "Mês")+
  theme(axis.title = element_text(size = 7), axis.text.x = element_text(angle=25, hjust = 1, size = 7))

# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-Month_SELIC.pdf", width = 6, height = 3)
season
meses
#dev.off()


m <- seas(x = selic, transform.function = "none", regression.aictest = NULL) 
#plot(m)
summary(m)
qs(m)
#summary(m) diz Series should not be a candidate for seasonal adjustment because the spectrum of the prior adjusted series (Table B1) has no visually significant seasonal peaks se for a série a partir de 99

# Usa a interface gráfica
#view(m)
sliding <- series(m, "sfs")
sum(sliding[,"Max_._DIFF"] > 3, na.rm = T)/length(na.omit(sliding[,"Max_._DIFF"])) * 100

# Salva a série final em uma nova variável
selic2 <- final(m)

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date(inicio), length = length(selic2), by = "1 month"), selic, selic2)
names(df) <- c("Data", "Original", "Série Filtrada")
p2 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = selic, colour = "Original")) +
  geom_line(aes(y = selic2, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+
  scale_y_continuous(name = "Selic (%a.a.)")+
  labs(color="Variável") +
  theme_bw()+theme(axis.text.x = element_text(angle=30, hjust = 1, size = 7))
p2

# Dividindo a série em pedaços distintos: 
# pega os pontos de quebras
bp_ts <- breakpoints(selic ~ 1)
# o valor com o menor BIC é o escolhido
summary(bp_ts)
# Calcula o intervalo de confiança
ci_ts <- confint(bp_ts)

Data <- seq(as.Date("1996-01-01"), length = length(selic), by = "1 month")
df1 <- melt(data.frame(Data,selic), id.vars = "Data")
names(df1) <- c("Data", "Variavel", "Valor")

p1 <- ggplot(df1[which(df1$Variavel == "selic"),], aes(Data, Valor, colour = Variavel)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[1])+
        scale_y_continuous(name="Selic (%a.a.)") +
        scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+ 
        geom_vline(xintercept = Data[bp_ts$breakpoints], linetype="longdash")+
        geom_segment(aes(x = Data[ci_ts$confint[1]], y = min(selic), xend = Data[ci_ts$confint[5]], yend = min(selic)))+
        geom_segment(aes(x = Data[ci_ts$confint[2]], y = min(selic), xend = Data[ci_ts$confint[6]], yend = min(selic)))+
        theme_bw()
p1 <- p1 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 6), legend.position = "none")

# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-Quebra_SELIC.pdf", width = 6, height = 3)
p1
#dev.off()



###########
# Dividindo a selic em três pedaços
##########

# Salvando três séries para passar o seasonal
selic_a <- selic[1:(bp_ts$breakpoints[1]-1)]
selic_b <- selic[(bp_ts$breakpoints[1]):(bp_ts$breakpoints[2]-1)]
selic_c <- selic[(bp_ts$breakpoints[2]):(length(selic))]
selic_a <- ts(selic_a,  start = c(1996, 01, 01), frequency = 12)
selic_b <- ts(selic_b,  start = c(1999, 05, 01), frequency = 12)
selic_c <- ts(selic_c,  start = c(2006, 08, 01), frequency = 12)

#######
# Primeiro pedaço
#########

ggmonthplot(selic_a) + 
  theme_bw() +
  scale_y_continuous(name = "Selic (%a.a - média)") +
  labs(title = "Média diária e mensal da taxa Selic", x = "Mês", subtitle = "Jan/96 a Abr/99")

# Gráfico por ano e mês
ggseasonplot(selic_a, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Selic (%a.a. - média)") +
  labs(title = "Média mensal da taxa Selic", x = "Mês", subtitle = "Jan/96 a Abr/99")

m <- seas(x = selic_a, transform.function = "none", regression.aictest = NULL) 
plot(m)
summary(m)
qs(m)
#summary(m) #diz Series should not be a candidate for seasonal adjustment because the spectrum of the prior adjusted series (Table B1) has no visually significant seasonal peaks

# Deixei ela como está

selic_2a <- selic_a

#######
# Segundo pedaço
#########

ggmonthplot(selic_b) + 
  theme_bw() +
  scale_y_continuous(name = "Selic (%a.a - média)") +
  labs(title = "Média diária e mensal da taxa Selic", x = "Mês", subtitle = "Mai/99 a Jul/06")

# Gráfico por ano e mês
ggseasonplot(selic_b, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Selic (%a.a. - média)") +
  labs(title = "Média mensal da taxa Selic", x = "Mês", subtitle = "Mai/99 a Jul/06")

m <- seas(x = selic_b, transform.function = "none", regression.aictest = NULL) 
plot(m)
summary(m)
qs(m)
summary(m)

selic_2b <- final(m)

ggmonthplot(selic_2b) + 
  theme_bw() +
  scale_y_continuous(name = "Selic (%a.a. - média)") +
  labs(title = "Média diária e mensal da Taxa Selic", x = "Mês", subtitle = "Mai/99 a Jul/06")

# Gráfico por ano e mês
ggseasonplot(selic_2b, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Selic (%a.a. - média)") +
  labs(title = "Média mensal da Taxa Selic", x = "Mês", subtitle = "Mai/99 a Jul/06")

selic_2b <- final(m)

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date("1999-05-01"), length = length(selic_b), by = "1 month"), selic_b, selic_2b)
names(df) <- c("Data", "Original", "Série Filtrada")
p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = selic_b, colour = "Original")) +
  geom_line(aes(y = selic_2b, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+
  scale_y_continuous(name = "Selic (%a.a.)")+
  labs(color="Série") +
  theme_bw() + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 9))
p1

#############
# Terceiro pedaço
#############

ggmonthplot(selic_c) + 
  theme_bw() +
  scale_y_continuous(name = "Selic (%a.a - média)") +
  labs(title = "Média diária e mensal da taxa Selic", x = "Mês", subtitle = "Ago/06 a Nov/17")

# Gráfico por ano e mês
ggseasonplot(selic_c, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Selic (%a.a. - média)") +
  labs(title = "Média mensal da taxa Selic", x = "Mês", subtitle = "Ago/06 a Nov/17")

m <- seas(x = selic_c, transform.function = "none", regression.aictest = NULL) 
plot(m)
summary(m)
qs(m)

selic_2c <- final(m)

ggmonthplot(selic_2c) + 
  theme_bw() +
  scale_y_continuous(name = "Selic (%a.a. - média)") +
  labs(title = "Média diária e mensal da Taxa Selic", x = "Mês", subtitle = "Ago/06 a Nov/17")

# Gráfico por ano e mês
ggseasonplot(selic_2c, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Selic (%a.a. - média)") +
  labs(title = "Média mensal da Taxa Selic", x = "Mês", subtitle = "Ago/06 a Nov/17")

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date("2006-08-01"), length = length(selic_c), by = "1 month"), selic_c, selic_2c)
names(df) <- c("Data", "Original", "Série Filtrada")
p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = selic_c, colour = "Original")) +
  geom_line(aes(y = selic_2c, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+
  scale_y_continuous(name = "Selic (%a.a.)")+
  labs(color="Série") +
  theme_bw() + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 9))
p1


###############
# Juntando novamente as três séries
###############

comb <- ts.union(selic_2a, selic_2b, selic_2c)
selic_final <- pmin(comb[,1], comb[,2], comb[,3], na.rm = TRUE)

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date("1996-01-01"), length = length(selic_final), by = "1 month"), selic, selic_final)
names(df) <- c("Data", "Original", "Série Filtrada")
p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = selic, colour = "Original"), linetype = "dashed") +
  geom_line(aes(y = selic_final, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Ano", labels = date_format("%Y"))+
  scale_y_continuous(name = "Selic (%a.a.)")+
  labs(color="Série") +
  scale_colour_manual("Variável", breaks = c("Original", "Filtrada"), values = c(cores[2], cores[1]))+
  theme_bw() + theme(axis.text.x = element_text(angle=30, hjust = 1, size = 7), legend.position = "top")
p1


# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-AntesDepois_SELIC.pdf", width = 6, height = 3)
p1
#dev.off()

m <- seas(x = selic, transform.function = "none", regression.aictest = NULL)
summary(m)
selic2 <- final(m)

df <- data.frame(seq(as.Date("1996-01-01"), length = length(selic_final), by = "1 month"), selic,  selic2, selic_final)
names(df) <- c("Data", "selic", "selic2", "selic_final")
p1 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = selic, colour = "Original")) +
  geom_line(aes(y = selic2, colour = "Automático")) +
  geom_line(aes(y = selic_final, colour = "Manual")) + 
  scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%m-%Y"))+
  scale_y_continuous(name = "Selic (%a.a.)")+
  labs(color="Método") +
  theme_bw() + theme(axis.text.x = element_text(angle=30, hjust = 1, size = 7))
p1
```

```{r, eval = FALSE}
#######################
# IBC-Br              #
#######################

m <- seas(x = ibcbr)
#plot(m)
#summary(m)

# Usa a interface gráfica
#view(m)

# Como ficou igual, também não mexi nele.
```

```{r}
#######################
# PIB Mensal          #
#######################
cores <- brewer.pal(6, "Dark2")
ggmonthplot(PIB) + 
  theme_bw() +
  scale_y_continuous(name = "PIB (log-dif - média)") +
  labs(title = "Média diária e mensal da variação do PIB", x = "Mês", subtitle = "Nenhuma transformação")

# Gráfico por ano e mês
ggseasonplot(PIB, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "PIB (log-dif - média)") +
  labs(title = "Média mensal da da variação do PIB", x = "Mês", subtitle = "Nenhuma transformação")

bp_ts <- breakpoints(PIB ~ 1) # Não tem quebra estrutural
# o valor com o menor BIC é o escolhido
summary(bp_ts)
# Calcula o intervalo de confiança
#ci_ts <- confint(bp_ts)

m <- seas(x = PIB, transform.function = "none", regression.aictest = NULL)
plot(m)
summary(m)

# Usa a interface gráfica
#view(m)

# Salva a série final em uma nova variável
PIB2 <- final(m)

# Compara a série ajustada com a série original
df <- data.frame(seq(as.Date("1996-01-01"), length = length(PIB), by = "1 month"), PIB, PIB2)
names(df) <- c("Data", "Original", "Série Filtrada")
p2 <- ggplot(df, aes(Data)) +
  geom_line(aes(y = PIB, colour = "Original"), linetype = "dashed") +
  geom_line(aes(y = PIB2, colour = "Filtrada")) + 
  scale_x_date(date_breaks = "12 months", name = "Ano", labels = date_format("%Y"))+
  scale_y_continuous(name = "PIB Mensal (% mensal)")+
  labs(color="Série") +
  scale_colour_manual("Variável", breaks = c("Original", "Filtrada"), values = c(cores[2], cores[1]))+
  theme_bw() + 
  theme(axis.text.x = element_text(angle=30, hjust = 1, size = 7), legend.position = "top")
p2 <- p2 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 7))

# Descomente para salvar em pdf
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-AntesDepois_PIB.pdf", width = 6, height = 3)
p2
#dev.off()
```

```{r}
#######################
# Câmbio              #
#######################
cores <- brewer.pal(6, "Dark2")
ggmonthplot(cambio) + 
  theme_bw() +
  scale_y_continuous(name = "Tx. Cambio (log-dif - média)") +
  labs(title = "Média diária e mensal da variação do Câmbio", x = "Mês", subtitle = "Nenhuma transformação")

# Gráfico por ano e mês
ggseasonplot(PIB, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "Tx. Cambio (log-dif - média)") +
  labs(title = "Média mensal da variação do Câmbio", x = "Mês", subtitle = "Nenhuma transformação")

m <- seas(x = cambio, transform.function = "none", regression.aictest = NULL)
plot(m)
summary(m) # Summary diz que não deve fazer ajuste sazonal

# Usa a interface gráfica
#view(m)
```


```{r}
#######################
# IPCA                #
#######################
cores <- brewer.pal(6, "Dark2")
ggmonthplot(ipca) + 
  theme_bw() +
  scale_y_continuous(name = "IPCA (% Acum. 12 meses - média)") +
  labs(title = "Média diária e mensal do IPCA acum. 12 meses", x = "Mês", subtitle = "Nenhuma transformação")

# Gráfico por ano e mês
ggseasonplot(ipca, year.labels = TRUE) + 
  geom_point() + 
  theme_bw() + 
  scale_y_continuous(name = "IPCA (% Acum. 12 meses - média)") +
  labs(title = "Média mensal do IPCA acum. 12 meses", x = "Mês", subtitle = "Nenhuma transformação")

m <- seas(x = ipca, transform.function = "none", regression.aictest = NULL)
#plot(m)
#summary(m) # Series should not be a candidate for seasonal adjustment because the spectrum of the prior adjusted series (Table B1) has no visually significant seasonal peaks.

# Usa a interface gráfica
#view(m)
```


```{r, eval = FALSE}
# Repete o mesmo gráfico de antes, mas com as variáveis dessazonalizadas

df1 <- data.frame(seq(as.Date(inicio), length = length(ipca), by = "1 month"), capital_trabalho2, selic2, ibcbr, cambio, ipca)
names(df1) <- c("Data", "Capital_trabalho", "Selic", "IBCBr", "Cambio", "IPCA")
df2 <- melt(data = df1, id.vars = "Data")

# Gráficos individuais
p1 <- ggplot(df2[which(df2$variable == "Capital_trabalho"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[1])+
        scale_y_continuous(name="Capital trabalho") +
        scale_x_date(date_breaks = "12 months")+ 
        theme_bw()
p1 <- p1 + theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p2 <- ggplot(df2[which(df2$variable == "Selic"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[2])+
        scale_y_continuous(name="Selic (%a.a.)") +
        scale_x_date(date_breaks = "12 months")+ 
        theme_bw()
p2 <- p2 + theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p3 <- ggplot(df2[which(df2$variable == "IBCBr"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[3])+
        scale_y_continuous(name="IBC-Br") +
        scale_x_date(date_breaks = "12 months")+
        theme_bw()
p3 <- p3 + theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p4 <- ggplot(df2[which(df2$variable == "Cambio"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[4])+
        scale_y_continuous(name="Tx. Câmbio (var)") +
        scale_x_date(date_breaks = "12 months")+
        theme_bw()
p4 <- p4 + theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p5 <- ggplot(df2[which(df2$variable == "IPCA"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[5])+
        scale_y_continuous(name="IPCA (acum. 12m.)") +
        scale_x_date(date_breaks = "12 months", name = "Data", labels = date_format("%Y"))+
        theme_bw()
p5 <- p5 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 6), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p6 <- ggplot(df2[which(df2$variable == "Swap90"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[2])+
        scale_y_continuous(name="Swap\n (%a.a.)") +
        scale_x_date(date_breaks = "12 months")+ 
        theme_bw()
p6 <- p6 + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

grid.arrange(p1, p5, p3, p6, p4, ncol=1, nrow = 5)

```


```{r}
# Repete o mesmo gráfico de antes, mas com as variáveis dessazonalizadas
scaleFUN  <- function(x) sprintf("%.1f", x)
scaleFUN2 <- function(x) sprintf("%.3f", x)

cores <- brewer.pal(6, "Dark2")
df1 <- data.frame(seq(as.Date(inicio), length = length(ipca), by = "1 month"), capital_trabalho_final*100, swap90, PIB2*100, cambio*100, ipca)
names(df1) <- c("Data", "Capital_trabalho", "Swap90", "PIB", "Cambio", "IPCA")
df2 <- melt(data = df1, id.vars = "Data")

# Gráficos individuais
p1a <- ggplot(df2[which(df2$variable == "Capital_trabalho"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[1])+
        scale_y_continuous(name="Capital trabalho\n", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months")+ 
        theme_bw()
p1a <- p1a + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p2a <- ggplot(df2[which(df2$variable == "Selic (%a.a.)"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[2])+
        scale_y_continuous(name="Selic\n (%a.a.)") +
        scale_x_date(date_breaks = "24 months")+ 
        theme_bw()
p2a <- p2a + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p3a <- ggplot(df2[which(df2$variable == "PIB"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[3])+
        scale_y_continuous(name="PIB \n(var % mensal)", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months")+
        theme_bw()
p3a <- p3a + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p4a <- ggplot(df2[which(df2$variable == "Cambio"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[4])+
        scale_y_continuous(name="Câmbio\n (var % mensal)", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months", name = "Ano", labels = date_format("%Y"))+
        theme_bw()
p4a <- p4a + theme(axis.text.y = element_text(size = 6), axis.text.x = element_text(angle=25, hjust = 1, size = 6), axis.title.x = element_text(size = 6), axis.title.y = element_text(size = 6),plot.margin = unit(c(0.009,0.08,0.0001,0.1), "cm"))

p5a <- ggplot(df2[which(df2$variable == "IPCA"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[5])+
        scale_y_continuous(name="IPCA\n (acum. 12m.)", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months", name = "Data", labels = date_format("%Y"))+
        theme_bw()
p5a <- p5a + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

p6a <- ggplot(df2[which(df2$variable == "Swap90"),], aes(Data, value, colour = variable)) +
        geom_line(alpha = 1, show.legend=F, colour = cores[2])+
        scale_y_continuous(name="Swap\n (%a.a.)", labels = scaleFUN) +
        scale_x_date(date_breaks = "24 months")+ 
        theme_bw()
p6a <- p6a + theme(axis.text.y = element_text(size = 6), axis.text.x=element_blank(), axis.title.x = element_blank(), axis.title.y = element_text(size = 6))

grid.arrange(p1a, p5a, p3a, p6a, p4a, ncol=2, nrow = 5)
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-Séries_semcom_ajuste.pdf", width = 6, height = 6)
grid.arrange(p1, p1a, p6, p5a, p3, p3a, p2, p6a, p4, p4a, ncol=2, nrow = 5)
#dev.off()


```


~~Parece que o X-13ARIMA fez um trabalho melhorzinho, então vou continuar com a série `capital_trabalho_adj`.~~

## Descritivas

~~Fiz as descritivas para a série original e depois para a série trabalhada manualmente e pelo X-13ARIMA.~~
Fiz as descritivas das variáveis que vão entrar no VAR. **Depois tem que lembrar de fazer das que efetivamente ficaram**
Uma ideia é colocar naqueles arquivos dos VAR individuais. Acho que vou fazer isso depois...

```{r, results='asis'}
### Descriptives

descriptives     <- matrix(NA, nrow = 8, ncol = (ncol(df1)-1))
rownames(descriptives) <- c("Observações", "Mínimo", "1o quartil",
                      "Média", "Mediana",  "3o quartil", "Máximo",
                      "Desv. Pad.")

#colnames(descriptives) <- names(df1)[-1]

desc <- function(x) {
  n       <- length(x)
  minimum <- min(x, na.rm = TRUE)
  first_q <- quantile(x, 0.25, na.rm = TRUE)
  media   <- mean(x, na.rm = TRUE)
  mediana <- median(x, na.rm = TRUE)
  third_q <- quantile(x, 0.75, na.rm = TRUE)
  maximum <- max(x, na.rm = TRUE)
  std     <- sd(x, na.rm = TRUE)

    return(list(n = n, minimum = minimum, first_quar = first_q, media = media, mediana = mediana, third_quar = third_q, maximum = maximum, std = std))
}

for (i in 1:8){
  descriptives[i, 1] <- round(as.numeric(desc(df1[,2])[i]),4)
  descriptives[i, 2] <- round(as.numeric(desc(df1[,6])[i]),4)
  descriptives[i, 3] <- round(as.numeric(desc(df1[,4])[i]),4)
  descriptives[i, 4] <- round(as.numeric(desc(df1[,3])[i]),4)
  descriptives[i, 5] <- round(as.numeric(desc(df1[,5])[i]),4)
}

descriptives[1,] <- as.integer(descriptives[1,])
names(descriptives) <- c(colnames(df1)[2], colnames(df1)[6], colnames(df1)[4], colnames(df1)[3], colnames(df1)[5])

descriptives <- data.frame(descriptives)

#stargazer(descriptives, summary=FALSE, header = TRUE, type = 'html')
stargazer(descriptives, summary=FALSE, header = TRUE, type = 'latex')
```

# Dados de desigualdade

Para os dados de desigualdade, peguei as seguintes séries, todas de 1976 em diante:

* **Do Diogo**
    * Índice de Gini, anual, de 76 a 2015 (tem alguns buracos nos anos de censo, ele usou PNAD)
    * Share dos 50% mais pobres e share dos 10% mais ricos (_também PNAD_)
* **Do IPEA Data**:
    * Proporção de domicílios pobres
    * Taxa de pobreza
    * Taxa de extrema pobreza
* **Do WID**:
    * PIB total
    * PIB per capita
* **Do World Bank**:
    * Taxa de crescimento anual do PIB
    * Índice de Gini

Como os dados são de fontes diferentes e a série do Diogo foi feita por ele, eu organizei um csv.

```{r}
desigualdade <- data.frame(read.csv("C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Desigualdade\\dados_desigualdade.csv", header = TRUE, sep = ";", dec = ","))
desigualdade[,1] <- seq(as.Date("1976-01-01"), length = nrow(desigualdade), by = "1 year")
```

Primeiro, vamos analisar a riqueza. Um dos argumentos é que para promover equidade primeiro o "bolo" tem que aumentar, para então dividir.

## Analisando o PIB

O `ggplot2` se recusa a fazer dois eixos, então dividi o PIB para deixar na mesma escala que o PIB per capita. Nâo consegui fazer uma legenda única. O gráfico mostra que houve crescimento tanto da riqueza agregada como riqueza per capita (poderia ser o caso onde tem tanta gente a mais que o PIB aumenta muito mais que o PIB per capita, mas não parece ser o caso).

Depois arrumar o nome do eixo x e y. Tentar colocar a legenda única. Aumentar o número de grids no eixo x.

```{r}
desigualdade[,8] <- desigualdade[,8]/100000000

df9 <- melt(data = desigualdade, id.vars = "ano")

# Não consegui evitar as duas legendas, copiei o plot pro ppt e arrumei na mão mesmo essa desgraça

p1 <- ggplot(df9[which(df9$variable == "pib"|df9$variable == "pib_per_capita" ),], aes(ano, value, color = factor(variable, labels = c("PIB*e-8", "PIB per capita")))) +
        geom_line(alpha = 1, aes(linetype = variable))+
        scale_y_continuous(name="Valor em reais (deflator = nov/17)") +
        scale_x_date(date_breaks = "24 months", name = "Ano", labels = date_format("%Y")) +
        theme_bw() +
        scale_colour_brewer(palette="Set1")
        
p1 <- p1 + theme(axis.text.x = element_text(angle=25, hjust = 1, size = 7), axis.title.x = element_text(size = 8),  axis.title.y = element_text(size = 7), legend.position="top", legend.text = element_text(size = 8), legend.title = element_text(size = 8), axis.text.y = element_text(size = 7), legend.key.size = unit(.5, "cm"), plot.margin = unit(c(0.009,0.08,0.1,0.1), "cm"))
#p1 <- p1 + labs(linetype = "Variável") # I couldn't fix the legend name properly, so why not use a gambiarra?
p1 <- p1 + labs(colour='Variável')

```

# Analisando a pobreza

Depois arrumar o nome do eixo x e y. Tentar colocar a legenda única. Aumentar o número de grids no eixo x.

```{r, message = FALSE, warning = FALSE}

p9 <- ggplot(df9[which(df9$variable == "prop_pobres"|df9$variable == "tx_pobreza" |df9$variable == "tx_ext_pobreza" ),], aes(ano, value, colour = variable)) +
  geom_line(alpha = 1, aes(linetype = variable))+
  labs(y = "%", x= "Ano", color = "Variável") +
  scale_x_date(date_breaks = "24 months", name = "Ano", labels = date_format("%Y"))+
  scale_colour_brewer(palette = "Set1") +
  theme_bw()

#p9 <- p9 + labs(linetype = "Variável", labels =  c("Prop. de pobres", "Tx. pobreza", "Tx. ext. pobreza")) 
p9 <- p9 + labs(colour="", labels =  c("Proporção de pobres", "Tx. pobreza", "Tx. ext. pobreza")) 
p9+ theme(axis.text.x = element_text(angle=25, hjust = 1, size = 7), axis.title.x = element_text(size = 8),  axis.title.y = element_text(size = 9), legend.position="top", legend.text = element_text(size = 8), legend.title = element_text(size = 8), axis.text.y = element_text(size = 9), legend.key.size = unit(.5, "cm"), plot.margin = unit(c(0.009,0.08,0.1,0.1), "cm"))

```

A pobreza parece estar diminuindo, mas e o que está acontecendo com a desigualdade?

## Medida de desigualdade

Comparando os 50% mais pobres com os 10% mais ricos.

Depois multiplicar o eixo y por 100.

```{r}
# Dados do Diogo
p9 <- ggplot(df9[which(df9$variable == "X50p_menor"|df9$variable == "decil_superior" ),], aes(ano, value, colour = variable)) +
  geom_line(alpha = 1, aes(linetype = variable))+
  labs(title="", y = "Share", x= "Ano", color = "Percentil") +
  scale_y_continuous(labels = percent, lim = c(0.10,0.60))+
  scale_x_date(date_breaks = "36 months", name = "Ano", labels = date_format("%Y"))+
  scale_colour_brewer(palette = "Set1", labels = c("50% mais pobres", "10% mais ricos"), name = "") +
  theme_bw()

#p9+ labs(colour="", labels =  c("50% mais pobres", "Decil mais rico")) 
p9 <- p9+ theme(axis.text.x = element_text(angle=45, hjust = 1, size = 7), axis.title.x = element_text(size = 8),  axis.title.y = element_text(size = 9), legend.position="top", legend.text = element_text(size = 8), legend.title = element_text(size = 8), axis.text.y = element_text(size = 9), legend.key.size = unit(.5, "cm"), plot.margin = unit(c(0.009,0.08,0.1,0.1), "cm"))

# Dados do WID
decis <- data.frame(read.csv("C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Desigualdade\\percentis_renda_wid.csv", header = TRUE, sep = ";", dec = "."))
decis[,2] <- as.Date(paste0(decis[,2],"-01-01"))

p10 <- ggplot(decis, aes(Year, Share, colour = Percentile)) +
  geom_line(alpha = 1, aes(linetype = Percentile), show.legend = T)+
  labs(title="", y = "Share", x= "Ano", color = "Percentil") +
  scale_y_continuous(labels = percent, lim = c(0.10,0.60))+
  scale_x_date(date_breaks = "12 months", name = "Ano", labels = date_format("%Y"))+
  scale_colour_brewer(palette = "Set1", labels = c("50% mais pobres", "10% mais ricos", "1% mais ricos"), name = "") +
  theme_bw()

p10 <- p10+ theme(axis.text.x = element_text(angle=45, hjust = 1, size = 7), axis.title.x = element_text(size = 8),  axis.title.y = element_blank(), legend.position="top", legend.text = element_text(size = 8), legend.title = element_text(size = 8), axis.text.y = element_text(size = 9), legend.key.size = unit(.5, "cm"), plot.margin = unit(c(0.009,0.08,0.1,0.1), "cm"))

ggarrange(p9, p10, ncol = 2, nrow = 1)

```

O que acontece quando colocarmos isso com a relação capital trabalho?

```{r}
share_1 <- desigualdade[,c(1,3)]
share_1 <- share_1[which(share_1$ano == as.Date("1992-01-01")):nrow(share_1),]

share_2 <- desigualdade[,c(1,4)]
share_2 <- share_2[which(share_2$ano == as.Date("1992-01-01")):nrow(share_2),]

capital_trabalho_completa <- BETS.get("7621", to = "2017-11-30")/BETS.get("7620", to = "2017-11-30") # capital/trabalho

trab_92 <- BETS.get("7620", from = "1994-08-01", to = "1999-12-30")
cap_92 <- BETS.get("7621", from = "1994-08-01", to = "1999-12-30")
cap_trab92 <- cap_99/trab_99

trab_99 <- BETS.get("7620", from = "1994-08-01", to = "1999-12-30")
cap_99 <- BETS.get("7621", from = "1994-08-01", to = "1999-12-30")
cap_trab99 <- cap_99/trab_99
ggarrange(autoplot(cap_99), autoplot(trab_99), autoplot(cap_trab99), ncol = 1, nrow = 3)
  
autoplot(capital_trabalho_completa)
#capital_trabalho_completa <- capital_trabalho_completa*100 #porque as outras variáveis estão em percentual
head(capital_trabalho_completa) # Começa em Janeiro de 1992
tail(capital_trabalho_completa) # Termina em Novembro de 2017

# Como vou fazer a média anual, não vou remover sazonalidade
# Calculando quantos anos completos eu tenho
pulo <- length(capital_trabalho_completa) %/% 12
ultimo <- length(capital_trabalho_completa) - (pulo)*12
sequencia <- seq(1,(length(capital_trabalho_completa)-ultimo), by = 12)
# 25 anos completos
capital_trabalho_anual <- vector()

for (i in 1:(pulo-1)){
  capital_trabalho_anual[i] <- mean(capital_trabalho_completa[seq(1,(length(capital_trabalho_completa)-ultimo), by = 12)[(i)]:seq(1,(length(capital_trabalho_completa)-ultimo), by = 12)[i+1]-1])
}

# Não preciso 2016 e 2017 pois não tem nas outras variáveis
# Mas não apaguei o código porque me deu um trabalho desgraçado
#capital_trabalho_anual[25] <- mean(capital_trabalho_completa[seq(1,(length(capital_trabalho_completa)-ultimo), by = 12)[(25)]:(seq(1,(length(capital_trabalho_completa)-ultimo), by = 12)[(25)]+11)])

#capital_trabalho_anual[26] <- mean(capital_trabalho_completa[(seq(1,(length(capital_trabalho_completa)-ultimo), by = 12)[(25)]+12):length(capital_trabalho_completa)])

df1 <- data.frame(share_1, share_2[,2], capital_trabalho_anual)
names(df1) <- c("ano", "x50_menor", "maior_decil", "ct_anual")
df2 <- melt(df1, id.vars = "ano")

p9 <- ggplot(df2, aes(ano, value, colour = variable)) +
  geom_line(alpha = 1, aes(linetype = variable), show.legend = F)+
  labs(title="Teste", y = "%", x= "Ano", color = "Variável") +
  scale_colour_brewer(palette = "Set1") +
  theme_bw()

p9 <- p9 + labs(linetype = "Variável") 
p9 <- p9 + labs(colour="Variável")
p9+ theme(legend.position="right", legend.key.size = unit(.5, "cm"))

p10 <- ggplot(df1, aes(x=ct_anual, y = maior_decil)) +
  geom_point() +
  scale_x_continuous(name = "Razão capital trabalho (%, média anual)")+
  scale_y_continuous(name = "Share dos 10% mais ricos")+
  theme_bw() +
  labs(title = "Razão cap/trabalho x share do maior decil de renda", subtitle = "Brasil, 1992-2015")

# Tendando fazer com os dados do WID
names(decis) <- c("Variavel", "Ano", "Percent")
df2 <- data.frame(paste("ct"), df1[10:(nrow(df1)),1], df1[10:(nrow(df1)),3])
names(df2) <- c("Variavel", "Ano", "Percent")
decis_ct <- rbind(decis, df2)

p10 <- ggplot(decis_ct, aes(Ano, Percent, colour = Variavel)) +
  geom_line(alpha = 1, aes(linetype = Variavel), show.legend = T)+
  labs(title="", y = "%", x= "Ano", color = "Variável") +
  scale_y_continuous(labels = percent, lim = c(0.10,.75))+
  scale_x_date(date_breaks = "12 months", name = "Ano", labels = date_format("%Y"))+
  scale_colour_brewer(palette = "Set1", labels = c("50% mais pobres", "10% mais ricos", "1% mais ricos", "Razão CT"), name = "") +
  theme_bw()

p10 <- p10+ theme(axis.text.x = element_text(angle=45, hjust = 1, size = 7), axis.title.x = element_text(size = 8),  axis.title.y = element_blank(), legend.position="top", legend.text = element_text(size = 8), legend.title = element_text(size = 8), axis.text.y = element_text(size = 9), legend.key.size = unit(.5, "cm"), plot.margin = unit(c(0.009,0.08,0.1,0.1), "cm"))

p10
```

Não parece estar muito interessante... Vamos ver o índice de Gini....

```{r}
p9 <- ggplot((df9[which(df9$variable == "gini"),]), aes(ano, value, colour = variable)) +
  geom_line(alpha = 1, show.legend = F)+
  labs(title="Índice de Gini", y = "Gini", x= "Ano") +
  scale_colour_brewer(palette = "Dark2") +
  theme_bw()
p9

# Agora com a razão capital trabalho

gini_1 <- desigualdade[,c(1,2)]
gini_1 <- gini_1[which(gini_1$ano == as.Date("1992-01-01")):nrow(gini_1),]

df1 <- data.frame(gini_1, capital_trabalho_anual)
names(df1) <- c("ano", "gini", "ct_anual")
df2 <- melt(df1, id.vars = "ano")

p9 <- ggplot(df2, aes(ano, value, colour = variable)) +
  geom_line(alpha = 1, aes(linetype = variable))+
  labs(title="", y = "", x= "Ano", color = "Variável") +
  scale_colour_brewer(palette = "Set1") +
  theme_bw()
p9 <- p9 + labs(linetype = "Variável") 
p9 <- p9 + labs(colour="Variável")
p9+ theme(legend.position="right", legend.key.size = unit(.5, "cm"))

cores <- brewer.pal(12, "Set3")
p10 <- ggplot(df1, aes(x=ct_anual, y = gini)) +
  geom_point() +
  geom_smooth(data = df1[-c(4,5,6),], aes(x=ct_anual, y = gini), method = "loess", linetype = "dashed", color = cores[4], fill = cores[9]) +
  scale_x_continuous(name = "Razão capital trabalho (%, média anual)")+
  scale_y_continuous(name = "Índice de Gini")+
  #geom_smooth()+
  theme_bw() #+
  #labs(title = "Razão cap/trabalho x índice de Gini", subtitle = "Brasil, 1992-2015")

#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-CTGini.pdf", width = 6, height = 3)
p10
#dev.off()

```

Claramente houve uma diminuição no índice que parece ter sido iniciada a partir dos anos 2000.
Além disso, parece haver um relacionamento em forma de raiz quadrada entre a razão capital trabalho e o índice de Gini, porém tem três outliers que estão ali no caminho.

```{r}
head(df1)

teste_1<-round(cor.test(df1[complete.cases(df1),][,2], df1[complete.cases(df1),][,3], method = "spearman", conf.level = 0.05)[[4]],4)
p_valor1 <- round(cor.test(df1[complete.cases(df1),][,2], df1[complete.cases(df1),][,3], method = "spearman", conf.level = 0.05)[[3]],4)

teste_2 <- round(cor.test(df1[complete.cases(df1),][-c(3,4,5),2], df1[complete.cases(df1),][-c(3,4,5),3], method = "spearman", conf.level = 0.05)[[4]],4)
p_valor2 <- round(cor.test(df1[complete.cases(df1),][-c(3,4,5),2], df1[complete.cases(df1),][-c(3,4,5),3], method = "spearman", conf.level = 0.05)[[3]],4)

```

Esses três outliers acontecem justamente nos anos que seguem a partir do plano real. Uma explicação possível é em relação à capac idade ociosa e à produtividade dos fatores. A correlação de Spearman entre o índice de Gini e a razão capital trabalho entre os anos de 1992 a 2015 (**depois tem que ver quais anos não tem Gini e ficaram de fora**) é de `r teste_1` (p-valor = `r p_valor1`). Removendo os anos de 95, 96 e 97, o valor do coeficiente de correlação aumenta para `r teste_2` (p-valor = `r p_valor2`).

## Crescimento econômico e desigualdade

Peguei os dados do World Bank do crescimento do PIB e do índice de Gini para países. Como o ano de 2010 parece ter mais pontos, fiquei com ele.

```{r}
pib_gini <- data.frame(read.csv("C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Desigualdade\\ginipib.csv", header = TRUE, sep = ";", dec = ","))

cores <- brewer.pal(12, "Set3")

names(pib_gini)[1] <- "pais"
head(pib_gini)

ggplot(pib_gini, aes(x=gini90, y = PIB90))+
  geom_point()

ggplot(pib_gini, aes(x=gini00, y = PIB00))+
  geom_point()

# Imputei o índice de Gini de 2009 que peguei do Diogo pq Brasil não tem PNAD em ano de Censo
pib_gini[which(pib_gini[,1] == "Brazil"),6]<-54.15

p11 <- ggplot(pib_gini, aes(x=gini10, y = PIB10))+
  geom_point(color = "darkred") +
  geom_point(data = pib_gini[which(pib_gini[,1] == "Brazil"),], color = cores[5], aes(x=gini10, y = PIB10, size = 0.6), shape = 18, show.legend = F)+
  geom_smooth(method = lm, linetype = "dashed", color = cores[4], fill = cores[9]) +
  geom_text(data = pib_gini[which(pib_gini[,1] == "Brazil"),], aes(x=gini10, y = PIB10+1.5, label = "BRA"), show.legend = F)+
  scale_y_continuous(name = "Crescimento do PIB em 2010 (%)")+
  scale_x_continuous(name = "Índice de Gini (x100)", breaks = seq(25,65,5))+
  #labs(title = "Tx. cresc. do PIB x Índice de Gini", subtitle = "Mundo, 2010") +
  theme_bw()
  
#pdf(file="C:\\Users\\Aishameriane\\OneDrive\\Documentos\\Mestrado Economia\\Teoria Macroeconômica II - 2017-2\\Artigo\\Aplicação\\Figuras artigo\\Fig-PIBGini.pdf", width = 6, height = 3)
p11
#dev.off()

# Inda tô vendo como calcular a correlação dos trem
#temp <- (data.frame(pib_gini[,6], pib_gini[,6])

```

# Jogando no liquidificador

O pacote que tem o modelo implementado é o `bvarsv`. Aqui (https://github.com/FK83/bvarsv/blob/master/bvarsv_Nov2015_website.pdf) e aqui (https://github.com/FK83/bvarsv/blob/master/bvarsv_replication.pdf) tem exemplos de uso.

Especificações da função `bvar.sv.tvp`:

* $p$ é o número de defasagens;
* $\tau$ é o número de observações que serão utilizadas para conseguir os hiperparâmetros. O default é 40, usei 24 (2 anos);
* $nf$ é o número de períodos para fazer previsão, o default é 10;
* $pdrift* parâmetro de tendência, default é TRUE;
* As distribuições a priori são as mesmas do Primiceri:
    * $B_0$ são os betas iniciais e seguem uma distribuição normal com parâmetros obtidos usando MQO
    * $A_0$ é a covariância inicial, também tem distribuição normal. As variâncias de $A_0$ e $B_0$ são multiplicadas por 4;
    * $log \ \sigma_0$ é a log volatilidade inicial, também segue uma densidade normal, com média estimada por MQO e variância unitária;
    * $Q$ matriz de variância covariância de $B_t$, tem distribuição inversa-wishart e uns parâmetros meio esquisitos (https://github.com/FK83/bvarsv/blob/master/bvarsv_Nov2015_website.pdf - ver página 2)
    * $W$ é a matriz decovariância dos choques em $log\ \sigma_0$
    * $S_j$ é a matriz de covariância de $A_t$


# Coisas a serem pensadas

* Uma coisa a ser feita é jogar esse IBC-Br fora e aumentar um pouco a amostra para ver o que acontece. 
* Tem a questão do câmbio também pra ser vista.
* E a questão da priori, talvez mude os resultados se eu mudar ela.

# Referências

